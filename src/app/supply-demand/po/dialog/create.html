<form
    ngNativeValidate
    fxLayout="column"
    class="dialog-content-wrapper"
    cdkDrag
    cdkDragRootElement=".cdk-overlay-pane"
    autocomplete="off"
    (ngSubmit)="Simpan()"
>
    <mat-toolbar cdkDragHandle matDialogTitle class="mat-primary m-0">
        <div fxFlex fxLayout="row" fxLayoutAlign="space-between center">
            <span class="title dialog-title">
                Create Purchase Order
            </span>
            <button
                mat-button
                type="button"
                class="mat-icon-button ml-24"
                mat-dialog-close
                aria-label="Close dialog"
                tabindex="-1"
                *ngIf="!Busy"
            >
                <mat-icon class="white-fg">close</mat-icon>
            </button>
        </div>
    </mat-toolbar>

    <mat-dialog-content fxLayout="row" fxLayout.sm="column" class="m-0 p-24">
        <!-- PARTIAL PO -->
        <mat-dialog-content fxFlex="1 1 auto" fxLayout="column">
            <!-- PRCode -->
            <mat-form-field
                appearance="outline"
                fxFlex="0 1 auto"
                class="small"
            >
                <mat-label>PR Code</mat-label>
                <input
                    matInput
                    type="text"
                    placeholder="Please Define PR Code to Continue"
                    name="pr_kode"
                    id="pr_kode"
                    [(ngModel)]="form.pr_kode"
                    [matAutocomplete]="acPRCode"
                    (ngModelChange)="PRCodeFilter(form.pr_kode)"
                    (focus)="PRCodeFilter(form.pr_kode)"
                    (click)="PRCodeFilter(form.pr_kode)"
                    [readonly]="form.is_detail || form.id != 'add' || form.pr"
                    [tabindex]="form.id != 'add' ? '-1' : ''"
                    required
                />
                <button
                    mat-button
                    type="button"
                    *ngIf="form.pr"
                    matSuffix
                    mat-icon-button
                    aria-label="Clear"
                    (click)="PRCodeRemove();"
                    tabindex="-1"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-autocomplete
                    autoActiveFirstOption
                    #acPRCode="matAutocomplete"
                    class="force-wrap ac-small"
                >
                    <mat-option
                        *ngFor="let item of PRCode"
                        [value]="item.kode"
                        (onSelectionChange)="PRCodeSelect($event, item)"
                    >
                        {{ item.kode }}
                    </mat-option>
                </mat-autocomplete>
            </mat-form-field>
            <!-- / PRCode -->

            <!-- SUPPLIER -->
            <mat-form-field
                appearance="outline"
                fxFlex="0 1 auto"
                *ngIf="form.pr"
                class="small"
            >
                <mat-label>Supplier</mat-label>
                <input
                    matInput
                    type="text"
                    placeholder="Please Select Supplier"
                    name="supplier_nama"
                    id="supplier_nama"
                    [(ngModel)]="form.supplier_nama"
                    [matAutocomplete]="acSupplier"
                    (ngModelChange)="SupplierFilter(form.supplier_nama)"
                    (focus)="SupplierFilter(form.supplier_nama)"
                    (click)="SupplierFilter(form.supplier_nama)"
                    [readonly]="SupplierLen == 1 || form.is_detail || form.id != 'add' || form.supplier"
                    [tabindex]="form.id != 'add' || SupplierLen == 1 ? '-1' : ''"
                    required
                />
                <button
                    type="button"
                    mat-button
                    *ngIf="form.pr"
                    matSuffix
                    mat-icon-button
                    aria-label="Clear"
                    (click)="SupplierRemove();"
                    tabindex="-1"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-autocomplete
                    autoActiveFirstOption
                    #acSupplier="matAutocomplete"
                    class="force-wrap ac-small"
                >
                    <mat-option
                        *ngFor="let item of Supplier"
                        [value]="item.nama"
                        (onSelectionChange)="SupplierSelect($event, item)"
                    >
                        {{ item.nama }}
                    </mat-option>
                </mat-autocomplete>
            </mat-form-field>
            <!-- / END : SUPPLIER -->

            <mat-form-field
                appearance="outline"
                fxFlex="0 1 auto"
                *ngIf="form.pr && form.supplier"
                class="small"
            >
                <mat-label>PO Date</mat-label>
                <input
                    matInput
                    name="tanggal"
                    placeholder="Please set PO Date"
                    [(ngModel)]="form.tanggal"
                    required
                    [matDatepicker]="tanggal"
                    [max]="maxDate"
                    (focus)="tanggal.open()"
                    (click)="tanggal.open()"
                    readonly
                    style="
                        font-size: 14px !important;
                        color: #000 !important;
                        padding: 0px !important;
                    "
                />
                <mat-datepicker #tanggal></mat-datepicker>
            </mat-form-field>
        </mat-dialog-content>
        <!-- END : // PARTIAL PO -->

        <!-- LIST ITEM -->
        <mat-dialog-content
            class="p-0 m-0 ml-24 mt-8"
            fxLayout="column"
            *ngIf="form.pr && form.supplier && form.list?.length > 0 && form?.tanggal"
        >
            <div>
                <table
                    class="table table-border-top table-list table-responsive table-input table-small"
                >
                    <thead>
                        <tr>
                            <th width="10" rowspan="2">
                                <mat-checkbox
                                    [checked]="form.allchecked == 1"
                                    (click)="SetAllChecked()"
                                ></mat-checkbox>
                            </th>
                            <th rowspan="2">
                                Name
                            </th>
                            <th width="100" rowspan="2">
                                Qty. Request
                            </th>
                            <th width="100" rowspan="2">
                                Qty. PO
                            </th>
                            <th width="50" rowspan="2">
                                Unit
                            </th>
                            <th colspan="2">
                                Unit Price
                            </th>
                            <th rowspan="2">
                                PPh
                            </th>
                            <th rowspan="2">
                                Origin / Quality
                            </th>
                            <th rowspan="2">
                                Remarks
                            </th>
                        </tr>
                        <tr>
                            <th width="100">
                                Cash
                            </th>
                            <th width="100">
                                Credit
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of form.list; let i = index;">
                            <td
                                align="center"
                                nopadding
                                (click)="SetChecked(i, item.selected)"
                            >
                                <mat-checkbox
                                    [checked]="item.selected == 1"
                                    (change)="SetChecked(i, item.selected)"
                                ></mat-checkbox>
                            </td>
                            <td padding5>
                                {{ item.nama }}
                            </td>
                            <td nopadding>
                                <input
                                    placeholder="Qty. Request"
                                    type="text"
                                    autocomplete="off"
                                    name="item-qty-{{i}}"
                                    id="item-qty-{{i}}"
                                    [ngModel]="item.qty_outstanding"
                                    maxlength="20"
                                    disabled
                                    currencyMask
                                    [options]="
                                        item.in_decimal == 1 ? {
                                            prefix: '',
                                            allowNegative: false,
                                            thousands: '.',
                                            decimal: ',',
                                            precision: 2
                                        } : {
                                            prefix: '',
                                            allowNegative: false,
                                            thousands: '.',
                                            decimal: ',',
                                            precision: 0
                                        }"
                                />
                            </td>
                            <td nopadding>
                                <input
                                    placeholder="Qty"
                                    type="text"
                                    autocomplete="off"
                                    name="item-qty_po-{{i}}"
                                    id="item-qty_po-{{i}}"
                                    [(ngModel)]="item.qty_po"
                                    [disabled]="!item.selected"
                                    [required]="item.selected == 1"
                                    (ngModelChange)="CalOutstanding(item)"
                                    maxlength="20"
                                    currencyMask
                                    [options]="item.in_decimal == 1 ? {
                                    prefix: '',
                                    allowNegative: false,
                                    thousands: '.',
                                    decimal: ',',
                                    precision: 2
                                } : {
                                    prefix: '',
                                    allowNegative: false,
                                    thousands: '.',
                                    decimal: ',',
                                    precision: 0
                                }"
                                />
                            </td>
                            <td class="text-center" padding5>
                                {{ item.satuan }}
                            </td>
                            <td>
                                <input
                                    placeholder="Cash Price"
                                    type="text"
                                    autocomplete="off"
                                    name="item-prc_cash-{{i}}"
                                    id="item-prc_cash-{{i}}"
                                    [(ngModel)]="item.prc_cash"
                                    [disabled]="!item.selected || item.prc_credit"
                                    maxlength="20"
                                    currencyMask
                                    [options]="{
                                    prefix: '',
                                    allowNegative: false,
                                    thousands: '.',
                                    decimal: ',',
                                    precision: 2
                                }"
                                    [ngClass]="item.prc_credit ? 'grey-900-bg' : ''"
                                />
                            </td>
                            <td>
                                <input
                                    placeholder="Credit Price"
                                    type="text"
                                    autocomplete="off"
                                    name="item-prc_credit-{{i}}"
                                    id="item-prc_credit-{{i}}"
                                    [(ngModel)]="item.prc_credit"
                                    [disabled]="!item.selected || item.prc_cash"
                                    maxlength="20"
                                    currencyMask
                                    [options]="{
                                    prefix: '',
                                    allowNegative: false,
                                    thousands: '.',
                                    decimal: ',',
                                    precision: 2
                                }"
                                    [ngClass]="item.prc_cash ? 'grey-900-bg' : ''"
                                />
                            </td>
                            <td nopadding class="text-center">
                                <mat-checkbox
                                    [(ngModel)]="item.pph"
                                    [checked]="item.pph == 1"
                                    name="pph-{{i}}"
                                    color="primary"
                                >
                                </mat-checkbox>
                            </td>
                            <td>
                                <input
                                    placeholder="Origin"
                                    type="text"
                                    autocomplete="off"
                                    name="item-origin-{{i}}"
                                    id="item-origin-{{i}}"
                                    [(ngModel)]="item.origin"
                                    [disabled]="!item.selected"
                                    maxlength="50"
                                />
                            </td>
                            <td>
                                <input
                                    placeholder="Remarks"
                                    type="text"
                                    autocomplete="off"
                                    name="item-note-{{i}}"
                                    id="item-note-{{i}}"
                                    [(ngModel)]="item.remarks"
                                    [disabled]="!item.selected"
                                    maxlength="150"
                                />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div fxFlex="1 1 auto" *ngIf="CheckedCount > 0">
                <table class="table table-small table-noborder">
                    <tr nopadding>
                        <td style="padding-right: 20px !important;">
                            <!-- <mat-form-field fxFlex="1 1 auto" floatLabel="always">
                                <input 
                                matInput
                                placeholder="Supplier Reference Number"
                                type="text" 
                                name="supplier_ref"
                                autocomplete="off"
                                [(ngModel)]="form.supplier_ref"
                                maxlength="150"
                                >
                            </mat-form-field> -->
                        </td>
                        <td width="250">
                            <table
                                class="table table-input table-input-border table-input-noborder"
                            >
                                <tr>
                                    <td width="100">Currency</td>
                                    <td width="1">:</td>
                                    <td>
                                        <select
                                            name="currency"
                                            [(ngModel)]="form.currency"
                                            required
                                            tabindex="-1"
                                        >
                                            <option
                                                *ngFor="let item of Cur"
                                                [value]="item.kode"
                                            >
                                                {{ item.kode }}
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                                <tr *ngIf="form.company == 3">
                                    <td width="100">Customs (KaBer)</td>
                                    <td width="1">:</td>
                                    <td>
                                        <select
                                            name="customs"
                                            [(ngModel)]="form.customs"
                                            required
                                            tabindex="-1"
                                        >
                                            <option value="1">Yes</option>
                                            <option value="2">No</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>DP (%)</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            placeholder="Down Payment in %"
                                            type="text"
                                            name="dp"
                                            autocomplete="off"
                                            [(ngModel)]="form.dp"
                                            maxlength="5"
                                            currencyMask
                                            required
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 0,
                                                suffix: ' %'
                                            }"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>PPN (%)</td>
                                    <td>:</td>
                                    <td>
                                        <select
                                            name="ppn"
                                            [(ngModel)]="form.ppn"
                                            tabindex="-1"
                                        >
                                            <option [value]="0">
                                                -
                                            </option>
                                            <option [value]="11">
                                                11 %
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                                <tr *ngIf="form.ppn == 10">
                                    <td>Inclusive</td>
                                    <td>:</td>
                                    <td>
                                        <select
                                            name="inclusive_ppn"
                                            [(ngModel)]="form.inclusive_ppn"
                                            tabindex="-1"
                                        >
                                            <option [value]="1">
                                                Yes
                                            </option>
                                            <option [value]="0">
                                                No
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>PPh Code</td>
                                    <td>:</td>
                                    <td>
                                        <select
                                            name="pph_code"
                                            [(ngModel)]="form.pph_code"
                                            (ngModelChange)="SetPPh()"
                                            tabindex="-1"
                                        >
                                            <option value="">
                                                -
                                            </option>
                                            <option
                                                *ngFor="let item of Default.pph"
                                                [value]="item.code"
                                            >
                                                {{ item.code }}
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                                <tr *ngIf="form.pph_code">
                                    <td>{{ form.pph_code }}</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            [placeholder]="form.pph_code"
                                            type="text"
                                            name="pph"
                                            autocomplete="off"
                                            [(ngModel)]="form.pph"
                                            readonly
                                            maxlength="5"
                                            currencyMask
                                            tabindex="-1"
                                            [options]="{
                                            prefix: '',
                                            allowNegative: true,
                                            thousands: '.',
                                            decimal: ',',
                                            precision: 2,
                                            suffix: ' %'
                                        }"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Disc. Cash</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            placeholder="Discount Cash (%)"
                                            type="text"
                                            name="disc_cash"
                                            autocomplete="off"
                                            [(ngModel)]="form.disc_cash"
                                            (ngModelChange)="DiscChange('cash', 'pct')"
                                            maxlength="14"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 2,
                                                suffix: ' %'
                                            }
                                        "
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Disc. Cash Amt</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            placeholder="Discount Cash (Amt)"
                                            type="text"
                                            name="disc_cash_amt"
                                            autocomplete="off"
                                            [(ngModel)]="form.disc_cash_amt"
                                            (ngModelChange)="DiscChange('cash', 'amt')"
                                            maxlength="14"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 2
                                            }
                                        "
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Disc. Credit</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            placeholder="Discount Credit (%)"
                                            type="text"
                                            name="disc_credit"
                                            autocomplete="off"
                                            [(ngModel)]="form.disc_credit"
                                            (ngModelChange)="DiscChange('credit', 'pct')"
                                            maxlength="14"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 2,
                                                suffix: ' %'
                                            }
                                        "
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Disc. Credit Amt</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            placeholder="Discount Credit (Amt)"
                                            type="text"
                                            name="disc_credit_amt"
                                            autocomplete="off"
                                            [(ngModel)]="form.disc_credit_amt"
                                            (ngModelChange)="DiscChange('credit', 'amt')"
                                            maxlength="14"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 2
                                            }
                                        "
                                        />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td width="300" class="pl-16">
                            <table
                                class="table table-input table-input-border table-input-noborder table-noborder"
                            >
                                <tr>
                                    <td width="150">Other Costs</td>
                                    <td width="1">:</td>
                                    <td>
                                        <input
                                            placeholder="Other Costs"
                                            type="text"
                                            name="other_costs"
                                            autocomplete="off"
                                            [(ngModel)]="form.other_cost"
                                            maxlength="20"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 2
                                            }"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td width="150">PPBKB</td>
                                    <td width="1">:</td>
                                    <td>
                                        <input
                                            placeholder="PPBKB"
                                            type="text"
                                            name="ppbkb"
                                            autocomplete="off"
                                            [(ngModel)]="form.ppbkb"
                                            maxlength="20"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 2
                                            }"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Delivery Plan</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            placeholder="Delivery Plan in Days"
                                            [(ngModel)]="form.delivery_plan"
                                            name="delivery_plan"
                                            required
                                            maxlength="8"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 0,
                                                suffix: form.delivery_plan > 1 ? ' days' : ' day',
                                                align: 'left'
                                            }"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Payment Terms</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            type="tel"
                                            name="payment_term"
                                            placeholder="in days"
                                            [(ngModel)]="form.payment_term"
                                            required
                                            maxlength="8"
                                            currencyMask
                                            [options]="
                                            {
                                                prefix: '',
                                                allowNegative: false,
                                                thousands: '.',
                                                decimal: ',',
                                                precision: 0,
                                                suffix: form.payment_term > 1 ? ' days' : ' day',
                                                align: 'left'
                                            }"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Price Expire</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            name="price_expire"
                                            placeholder="Price Expire Date"
                                            [(ngModel)]="form.price_expire"
                                            [min]="minDate"
                                            required
                                            [matDatepicker]="price_expire"
                                            (focus)="price_expire.open()"
                                            (click)="price_expire.open()"
                                            readonly
                                        />
                                        <mat-datepicker
                                            #price_expire
                                        ></mat-datepicker>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Delivery Term</td>
                                    <td>:</td>
                                    <td>
                                        <select
                                            name="delivery_term"
                                            [(ngModel)]="form.delivery_term"
                                            required
                                        >
                                            <option value="1">Supplier</option>
                                            <option value="2">Buyer</option>
                                        </select>
                                    </td>
                                </tr>
                                <!-- <tr>
                                    <td>Weight Base</td>
                                    <td>:</td>
                                    <td>
                                        <select
                                            name="weight_base"
                                            [(ngModel)]="form.weight_base"
                                            (ngModelChange)="alertWeightBase()"
                                        >
                                            <option value="0">Buyer</option>
                                            <option value="1">Supplier</option>
                                        </select>
                                    </td>
                                </tr> -->
                                <tr>
                                    <td>Delivery Location</td>
                                    <td>:</td>
                                    <td style="position: relative;">
                                        <input 
                                            *ngIf="!form.is_detail || !PO.kode"
                                            type="text" 
                                            autocomplete="off"
                                            name="storeloc_nama" 
                                            id="storeloc_nama" 
                                            placeholder="Select Delivery Location"
                                            [(ngModel)]="form.storeloc_nama"
                                            required
                                            [matAutocomplete]="acStoreloc"
                                            (ngModelChange)="StorelocFilter(form.storeloc_nama)"
                                            [readonly]="form.storeloc"
                                        >
                                        <button
                                            type="button"
                                            style="position: absolute; right: 0px;"
                                            mat-button
                                            *ngIf="!form.is_detail && form.storeloc"
                                            matSuffix
                                            mat-icon-button
                                            aria-label="Clear"
                                            (click)="StorelocReset(); SupplierFilter(form.storeloc_nama);"
                                            tabindex="-1"
                                        >
                                            <mat-icon>close</mat-icon>
                                        </button>
                                        <mat-autocomplete #acStoreloc="matAutocomplete" class="force-wrap ac-small">
                                            <mat-option value="LOCO">
                                                LOCO
                                            </mat-option>
                                            <mat-option *ngFor="let item of Storeloc" [value]="item.nama" (onSelectionChange)="StorelocSelect($event, item)">
                                                {{ item.kode }} :
                                                {{ item.nama }}
                                            </mat-option>
                                        </mat-autocomplete>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Note</td>
                                    <td>:</td>
                                    <td>
                                        <input
                                            name="note"
                                            type="text"
                                            placeholder="Input Note"
                                            autocomplete="off"
                                            [(ngModel)]="form.note"
                                            required
                                        >
                                    </td>
                                </tr>
                                <!-- Matikan dulu sebelum timbangan clear -->
                                <!-- <tr>
                                    <td>PO Contract</td>
                                    <td>:</td>
                                    <td>
                                        <select
                                            name="po_contract"
                                            [(ngModel)]="form.po_contract"
                                            (ngModelChange)="alertPOContract()"
                                        >
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                        </select>
                                    </td>
                                </tr> -->
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        </mat-dialog-content>
        <!-- / END : LIST ITEM -->
    </mat-dialog-content>

    <!-- ACTIONS -->
    <mat-dialog-actions
        class="p-16 m-0"
        fxLayout="row"
        fxLayoutAlign="end"
        fxLayoutGap="10px"
    >
        <div fxFlex="1 1 auto" fxLayout="row">
            <button
                type="submit"
                mat-button
                color="primary"
                [disabled]="
                    !form?.tanggal || 
                    !form?.pr || 
                    !form?.supplier || 
                    CheckedCount <= 0 || 
                    Busy
                "
            >
                <mat-icon>save</mat-icon>
                Create PO
            </button>
        </div>

        <div>
            <button *ngIf="!Busy" type="button" mat-button mat-dialog-close>
                <mat-icon>close</mat-icon>
                Close
            </button>
        </div>
    </mat-dialog-actions>
    <!-- / END : ACTION -->
</form>
